/**
 * VulnerabilityFilter
 * Allows users to select vulnerabilities and find related modules and machines
 */

import { useEffect, useState } from "react";
import { Label } from "@/components/ui/label";
import { Button } from "@/components/ui/button";
import { Checkbox } from "@/components/ui/checkbox";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { X } from "lucide-react";
import type { Vulnerability } from "@/types";
import { useUrlParams } from "@/hooks/useUrlParams";
import Loader from "@/components/loader";

interface VulnerabilityFilterProps {
  onApply: (mode: "vulnerability", filters: { vulnerabilityIds: number[] }) => void;
  isLoading?: boolean;
  isPreloading?: boolean;
  vulnerabilities: Vulnerability[];
}

export function VulnerabilityFilter({ onApply, isLoading, isPreloading, vulnerabilities }: VulnerabilityFilterProps) {
  const { params, updateParams } = useUrlParams();
  const [selectedIds, setSelectedIds] = useState<number[]>([]);
  const [searchQuery, setSearchQuery] = useState("");

  // Initialize selected IDs from URL params
  useEffect(() => {
    if (params.vulnerabilities) {
      const ids = params.vulnerabilities.split(",").map(Number).filter(Boolean);
      setSelectedIds(ids);
    }
  }, [params.vulnerabilities]);

  // Auto-apply filter if vulnerabilities are in URL params
  useEffect(() => {
    if (params.vulnerabilities && vulnerabilities.length > 0 && selectedIds.length > 0) {
      handleApply();
    }
  }, [params.vulnerabilities, vulnerabilities]);

  const handleApply = () => {
    if (selectedIds.length === 0) return;

    updateParams({ vulnerabilities: selectedIds.join(","), page: "1" });
    onApply("vulnerability", { vulnerabilityIds: selectedIds });
  };

  const handleToggle = (id: number) => {
    setSelectedIds((prev) =>
      prev.includes(id) ? prev.filter((item) => item !== id) : [...prev, id]
    );
  };

  const handleClearAll = () => {
    setSelectedIds([]);
  };

  // Filter vulnerabilities based on search query
  const filteredVulnerabilities = vulnerabilities.filter((vuln) =>
    vuln.name?.toLowerCase().includes(searchQuery.toLowerCase())
  );

  // Get selected vulnerability objects for display
  const selectedVulnerabilities = vulnerabilities.filter((vuln) =>
    selectedIds.includes(vuln.id)
  );

  return (
    <div className="space-y-6">
      <div className="space-y-3">
        <Label className="text-sm font-semibold">Select Vulnerabilities</Label>

        <Input
          type="text"
          placeholder="Search vulnerabilities..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
        />

        {isPreloading ? (
          <div className="flex items-center justify-center py-8">
            <Loader />
          </div>
        ) : (
          <ScrollArea className="h-[240px] border p-4">
            <div className="space-y-3">
              {filteredVulnerabilities.length === 0 ? (
                <p className="text-sm text-muted-foreground text-center py-4">
                  No vulnerabilities found
                </p>
              ) : (
                filteredVulnerabilities.map((vuln) => (
                  <div key={vuln.id} className="flex items-center space-x-2">
                    <Checkbox
                      id={`vuln-${vuln.id}`}
                      checked={selectedIds.includes(vuln.id)}
                      onCheckedChange={() => handleToggle(vuln.id)}
                    />
                    <label
                      htmlFor={`vuln-${vuln.id}`}
                      className="text-sm font-medium leading-relaxed peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer"
                    >
                      {vuln.name || `Vulnerability ${vuln.id}`}
                    </label>
                  </div>
                ))
              )}
            </div>
          </ScrollArea>
        )}

        {/* Selected Items Display */}
        {selectedIds.length > 0 && (
          <div className="space-y-2 pt-2 border-t">
            <div className="flex items-center justify-between">
              <Label className="text-xs text-muted-foreground">
                Selected ({selectedIds.length})
              </Label>
              <Button
                variant="ghost"
                size="sm"
                onClick={handleClearAll}
                className="h-auto py-1 px-2 text-xs hover:text-destructive"
              >
                Clear All
              </Button>
            </div>
            <div className="flex flex-wrap gap-1.5">
              {selectedVulnerabilities.map((vuln) => (
                <Badge
                  key={vuln.id}
                  variant="secondary"
                  className="text-xs pl-2 pr-1 py-1 gap-1"
                >
                  <span className="max-w-[200px] truncate">
                    {vuln.name || `Vulnerability ${vuln.id}`}
                  </span>
                  <button
                    onClick={() => handleToggle(vuln.id)}
                    className="hover:bg-secondary-foreground/20 rounded-full p-0.5"
                  >
                    <X className="h-3 w-3" />
                  </button>
                </Badge>
              ))}
            </div>
          </div>
        )}
      </div>

      <div className="rounded-md bg-muted/50 p-3">
        <p className="text-xs text-muted-foreground leading-relaxed">
          Find modules that teach these vulnerabilities and machines that contain them.
        </p>
      </div>

      <Button
        onClick={handleApply}
        disabled={selectedIds.length === 0 || isLoading || isPreloading}
        className="w-full h-10"
        size="default"
      >
        {isLoading ? "Loading..." : `Find Resources (${selectedIds.length} selected)`}
      </Button>
    </div>
  );
}
